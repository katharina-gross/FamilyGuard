<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyGuard: AI-Powered Parental Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        #dashboardPage #addDeviceBtn {
        display: none;
    }
        :root {
            --primary: #4361ee;
            --primary-light: #5a75f0;
            --primary-dark: #2d4bc4;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #ff9e00;
            --info: #00b4d8;
            --light: #f8f9fa;
            --light-gray: #f0f2f5;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            --radius: 10px;
            --radius-sm: 6px;
            --transition: all 0.3s ease;

            --bg-body: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            --bg-card: white;
            --bg-header: white;
            --text-primary: #212529;
            --text-secondary: #6c757d;
        }

        .dark-theme {
            --bg-body: linear-gradient(135deg, #121212 0%, #1a1a1a 100%);
            --bg-card: #1e1e1e;
            --bg-header: #1e1e1e;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border: #333;
            --shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
            --light-gray: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--bg-header);
            box-shadow: var(--shadow);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: var(--transition);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 1.8rem;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav li {
            margin-left: 20px;
        }

        nav a {
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav a:hover, nav a.active {
            color: var(--primary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .auth-buttons button {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-login {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-login:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .btn-register {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-register:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #3023ae 100%);
        }

        .page {
            display: none;
            padding: 40px 0;
            flex: 1;
        }

        .page.active {
            display: block;
        }

        .page-title {
            font-size: 2rem;
            margin-bottom: 30px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i {
            color: var(--primary);
            font-size: 1.8rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn i {
            font-size: 1.1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #3023ae 100%);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: rgba(67, 97, 238, 0.05);
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-icon {
            padding: 8px 10px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .device-card {
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 20px;
            position: relative;
            transition: var(--transition);
        }

        .device-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .device-name {
            font-size: 1.2rem;
            margin-bottom: 5px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .device-name i {
            color: var(--gray);
            font-size: 1.4rem;
        }

        .device-info {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .device-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .device-info-grid > div {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .device-status {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }

        .device-status.offline {
            background: #dc3545;
        }

        .device-status.blocked {
            background: #ffc107;
        }

        .device-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .qr-code-container {
            text-align: center;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            max-width: 300px;
            margin: 0 auto;
            box-shadow: var(--shadow);
        }

        .qr-code {
            width: 200px;
            height: 200px;
            background: #f0f2f5;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            border-radius: var(--radius-sm);
            color: var(--primary);
        }

        .binding-code {
            font-size: 1.8rem;
            letter-spacing: 3px;
            font-weight: 700;
            margin: 20px 0;
            color: var(--primary);
            background: #f0f2f5;
            padding: 10px;
            border-radius: var(--radius-sm);
        }

        .tab-container {
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            gap: 5px;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 500;
            position: relative;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            background: #f0f2f5;
            transition: var(--transition);
        }

        .tab:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        .tab.active {
            color: var(--primary);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom: none;
        }

        .tab-content {
            padding: 25px;
            background: var(--bg-card);
            border-radius: 0 var(--radius) var(--radius) var(--radius);
            border: 1px solid var(--border);
            border-top: none;
        }

        .notification {
            padding: 15px 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            font-weight: 500;
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification i {
            font-size: 1.3rem;
        }

        .notification.success {
            background: rgba(40, 167, 69, 0.95);
            color: white;
        }

        .notification.error {
            background: rgba(220, 53, 69, 0.95);
            color: white;
        }

        .notification.warning {
            background: rgba(255, 158, 0, 0.95);
            color: white;
        }

        .notification.info {
            background: rgba(0, 180, 216, 0.95);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--border);
            margin-bottom: 20px;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        footer {
            background: var(--bg-card);
            padding: 30px 0;
            text-align: center;
            margin-top: auto;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            padding: 20px;
            border-radius: var(--radius);
            background: var(--bg-card);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--text-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .schedule-item {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-details {
            flex: 1;
        }

        .schedule-actions {
            display: flex;
            gap: 8px;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .profile-card {
            grid-column: 1 / -1;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .settings-section {
            background: var(--light-gray);
            padding: 20px;
            border-radius: var(--radius-sm);
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-time {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
            position: relative;
        }

        .chart-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .schedule-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .schedule-form-grid .form-group:last-child {
            grid-column: 1 / -1;
        }

        .schedule-form-grid .btn {
            grid-column: 1 / -1;
        }

        .stats-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chart-type-selector {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .chart-type-selector .btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
        }

        .chart-type-selector .btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .days-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .days-selector label {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .days-selector input[type="checkbox"] {
            margin: 0;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .comparison-chart {
            height: 250px;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            margin-left: 10px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        .trend-neutral {
            color: var(--warning);
        }

        .usage-comparison {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 15px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .comparison-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        #mobileMenuBtn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .theme-switcher {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-option.active {
            border-color: var(--primary);
        }

        .theme-light {
            background: linear-gradient(to right, #f0f4ff 50%, #1e1e1e 50%);
        }

        .theme-dark {
            background: #1e1e1e;
        }

        .theme-system {
            background: linear-gradient(to right, #f0f4ff 50%, #1e1e1e 50%);
            position: relative;
            overflow: hidden;
        }

        .theme-system:after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, #1e1e1e 30%, transparent 30%);
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .schedule-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .schedule-time {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .schedule-days {
            display: flex;
            gap: 5px;
        }

        .day {
            padding: 3px 8px;
            border-radius: 20px;
            background: var(--light-gray);
            font-size: 0.85rem;
        }

        .day.active {
            background: var(--primary);
            color: white;
        }

        .schedule-device {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-top: 1px solid var(--border);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(21px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-trend {
            font-size: 0.85rem;
            padding: 3px 8px;
            border-radius: 20px;
            background: var(--light-gray);
            color: var(--text-secondary);
        }

        .stat-progress {
            height: 5px;
            background: var(--light-gray);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
        }

        .map-container {
            height: 500px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--primary-light);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            background: var(--light-gray);
        }

        .screenshot-container {
            margin: 15px 0;
            text-align: center;
        }

        .screenshot-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius-sm);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .category-limits {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .limit-item {
            background: var(--light-gray);
            padding: 12px 15px;
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .limit-value {
            font-weight: 600;
            color: var(--primary);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-label {
            font-size: 0.9rem;
        }

        .limit-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .limit-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
        }

        .limit-controls {
            display: flex;
            gap: 5px;
        }

        .category-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .category-item-content {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .category-details {
            flex: 1;
        }

        .monitoring-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .categories-sidebar {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            height: calc(100vh - 200px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .categories-sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .search-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 8px 15px 8px 35px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--light-gray);
            color: var(--text-primary);
        }

        .search-container i {
            position: absolute;
            left: 10px;
            color: var(--text-secondary);
        }

        .categories-filter {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .filter-tab {
            padding: 5px 12px;
            font-size: 0.85rem;
            border-radius: 20px;
            cursor: pointer;
            background: var(--light-gray);
            color: var(--text-secondary);
        }

        .filter-tab.active {
            background: var(--primary);
            color: white;
        }

        .category-stats-summary {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
        }

        .stat-value {
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .monitoring-content {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            height: calc(100vh - 200px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-left h3 {
            margin-bottom: 5px;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            margin-right: 15px;
        }

        .view-toggle .btn {
            padding: 8px;
        }

        .view-toggle .btn.active {
            background: var(--primary);
            color: white;
        }

        .screenshots-list {
            display: none;
        }

        .screenshot-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            gap: 15px;
        }

        .screenshot-list-image {
            width: 100px;
            height: 60px;
            border-radius: var(--radius-sm);
            object-fit: cover;
        }

        .screenshot-list-details {
            flex: 1;
        }

        .screenshot-list-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .screenshot-list-actions {
            display: flex;
            gap: 8px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .page-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screenshot-card, .screenshot-list-item {
            animation: fadeIn 0.3s ease forwards;
        }

        .category-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: var(--radius-sm);
            background: var(--light-gray);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
            position: relative;
        }

        .category-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .category-item.active {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-size: 1.5rem;
        }

        .category-info {
            flex: 1;
            min-width: 0;
        }

        .category-name {
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .category-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .screenshots-list {
            display: none;
            margin-top: 20px;
        }

        .screenshot-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            gap: 15px;
            background: var(--bg-card);
            margin-bottom: 5px;
            border-radius: var(--radius-sm);
        }

        .screenshot-list-image {
            width: 100px;
            height: 60px;
            border-radius: var(--radius-sm);
            object-fit: cover;
        }

        .screenshot-list-details {
            flex: 1;
        }

        .screenshot-list-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .screenshot-list-actions {
            display: flex;
            gap: 8px;
        }

        .category-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
        }

        .category-item:hover .category-actions {
            display: flex;
            gap: 5px;
        }

        .category-action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .category-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        .screenshots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .screenshot-card {
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            transition: var(--transition);
        }

        .screenshot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .screenshot-image-container {
            height: 180px;
            overflow: hidden;
            position: relative;
        }

        .screenshot-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .screenshot-card:hover .screenshot-image {
            transform: scale(1.05);
        }

        .screenshot-meta {
            padding: 12px;
            background: var(--bg-card);
        }

        .screenshot-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .screenshot-device {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .screenshot-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .monitoring-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .empty-screenshots {
            text-align: center;
            padding: 40px 20px;
            grid-column: 1 / -1;
        }

        .empty-screenshots i {
            font-size: 3rem;
            color: var(--border);
            margin-bottom: 15px;
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
        }

        .emoji-option {
            font-size: 1.5rem;
            cursor: pointer;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
            transition: var(--transition);
        }

        .emoji-option:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        .emoji-option.selected {
            background: var(--primary);
            color: white;
        }

        .time-limit-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .time-limit-input {
            flex: 1;
        }

        .time-limit-buttons {
            display: flex;
            gap: 5px;
        }

        .screenshot-viewer {
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
            height: auto;
            border-radius: var(--radius-sm);
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .screenshot-viewer-container {
            text-align: center;
            padding: 20px;
            position: relative;
        }

        .screenshot-meta-info {
            margin-top: 15px;
            text-align: center;
            color: var(--text-secondary);
        }

        .screenshot-viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .confirmation-dialog {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 25px;
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .monitoring-empty-state {
            text-align: center;
            padding: 40px 20px;
            grid-column: 1 / -1;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .screenshot-loading {
            height: 180px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            animation: pulse 1.5s infinite;
        }

        .date-range-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .ai-badge {
            background: var(--info);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .screenshot-ai-info {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--info);
            margin: 5px 0;
        }

        .ai-analysis-tag {
            background: rgba(0, 180, 216, 0.1);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        @media (max-width: 992px) {
            .monitoring-container {
                grid-template-columns: 1fr;
            }

            .categories-sidebar {
                height: auto;
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            nav ul {
                margin-top: 15px;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            nav li {
                margin-left: 0;
            }

            .user-menu {
                margin-top: 15px;
                flex-direction: column;
            }

            .devices-grid {
                grid-template-columns: 1fr;
            }

            .profile-grid,
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .schedule-form-grid {
                grid-template-columns: 1fr;
            }

            .stats-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .chart-type-selector {
                margin-left: 0;
                justify-content: center;
            }

            .comparison-container {
                grid-template-columns: 1fr;
            }

            #mobileMenuBtn {
                display: block;
            }

            #mainNav {
                display: none;
                width: 100%;
                margin-top: 15px;
            }

            #mainNav.active {
                display: block;
            }

            nav ul {
                flex-direction: column;
            }

            .emoji-picker {
                grid-template-columns: repeat(4, 1fr);
            }

            .category-item {
                padding: 10px;
            }

            .category-icon {
                width: 32px;
                height: 32px;
                font-size: 1.2rem;
            }
        }

            /* Скрыть кнопку экспорта на странице мониторинга */
    #monitoringPage #exportScreenshots {
        display: none;
    }

    /* Скрыть кнопки выбора типа графика на странице статистики */
    #statisticsPage .chart-type-selector {
        display: none;
    }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>FamilyGuard AI</span>
                </div>

                <button id="mobileMenuBtn" class="btn btn-outline">
                    <i class="fas fa-bars"></i>
                </button>

                <nav id="mainNav">
                    <ul>
                        <li><a href="#" class="nav-link" data-page="dashboard"><i class="fas fa-home"></i> Home</a></li>
                        <li><a href="#" class="nav-link" data-page="devices"><i class="fas fa-mobile-alt"></i> Devices</a></li>
                        <li><a href="#" class="nav-link" data-page="monitoring"><i class="fas fa-eye"></i> Monitoring</a></li>
                        <li><a href="#" class="nav-link" data-page="statistics"><i class="fas fa-chart-bar"></i> Statistics</a></li>
                        <li><a href="#" class="nav-link" data-page="profile"><i class="fas fa-user-cog"></i> Profile</a></li>
                    </ul>
                </nav>
                <div class="user-menu" id="userMenu">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Loader -->
        <div class="loader" id="globalLoader">
            <div class="loader-spinner"></div>
        </div>

        <!-- Notifications -->
        <div id="notification" class="notification"></div>

        <!-- Login Page -->
        <div id="loginPage" class="page active">
            <div class="card" style="max-width: 500px; margin: 40px auto;">
                <h1 class="page-title" style="text-align: center;"><i class="fas fa-sign-in-alt"></i> Login</h1>

                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                    </div>

                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Register Page -->
        <div id="registerPage" class="page">
            <div class="card" style="max-width: 500px; margin: 40px auto;">
                <h1 class="page-title" style="text-align: center;"><i class="fas fa-user-plus"></i> Register</h1>

                <form id="registerForm">
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" class="form-control" placeholder="example: User" required>
                    </div>

                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" class="form-control" placeholder="example: User" required>
                    </div>

                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" class="form-control" placeholder="example: test@gmail.com" required>
                    </div>

                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" class="form-control" placeholder="Create a password (min 6 characters)" minlength="6" required>
                    </div>

                    <div class="form-group">
                        <label for="timezone">Timezone</label>
                        <select id="timezone" class="form-control" required>
                            <option value="">Select your timezone</option>
                            <option value="UTC-12">UTC-12:00</option>
                            <option value="UTC-11">UTC-11:00</option>
                            <option value="UTC-10">UTC-10:00</option>
                            <option value="UTC-9">UTC-09:00</option>
                            <option value="UTC-8">UTC-08:00</option>
                            <option value="UTC-7">UTC-07:00</option>
                            <option value="UTC-6">UTC-06:00</option>
                            <option value="UTC-5">UTC-05:00</option>
                            <option value="UTC-4">UTC-04:00</option>
                            <option value="UTC-3">UTC-03:00</option>
                            <option value="UTC-2">UTC-02:00</option>
                            <option value="UTC-1">UTC-01:00</option>
                            <option value="UTC">UTC±00:00</option>
                            <option value="UTC+1">UTC+01:00</option>
                            <option value="UTC+2">UTC+02:00</option>
                            <option value="UTC+3">UTC+03:00</option>
                            <option value="UTC+4">UTC+04:00</option>
                            <option value="UTC+5">UTC+05:00</option>
                            <option value="UTC+6">UTC+06:00</option>
                            <option value="UTC+7">UTC+07:00</option>
                            <option value="UTC+8">UTC+08:00</option>
                            <option value="UTC+9">UTC+09:00</option>
                            <option value="UTC+10">UTC+10:00</option>
                            <option value="UTC+11">UTC+11:00</option>
                            <option value="UTC+12">UTC+12:00</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" class="form-control" placeholder="example: 89990009999">
                    </div>

                    <div class="form-group" style="margin-top: 30px;">
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-user-plus"></i> Create Account
                        </button>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page">
            <h1 class="page-title"><i class="fas fa-home"></i> Control Dashboard</h1>

            <div class="user-menu" style="margin-bottom: 20px;">
                <button id="emergencyLock" class="btn btn-danger">
                    <i class="fas fa-lock"></i> Emergency Lock All Devices
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Linked Devices</h2>
                    <button id="addDeviceBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Device</button>
                </div>
                <div class="devices-grid" id="devicesGrid">
                    <!-- Devices will be added dynamically -->
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Recent Notifications</h2>
                </div>
                <div id="recentNotifications">
                    <!-- Notifications will be added dynamically -->
                </div>
            </div>
        </div>

        <!-- Devices Page -->
        <div id="devicesPage" class="page">
            <h1 class="page-title"><i class="fas fa-mobile-alt"></i> Devices Management</h1>

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="bind-device">Tether Device</div>
                    <div class="tab" data-tab="manage-devices">My Devices</div>
                </div>

                <div class="tab-content">
                    <div id="bindDeviceTab" class="tab-pane active">
                        <div class="card">
                            <h2 style="margin-bottom: 20px; text-align: center;">Tether New Device</h2>

                            <div class="qr-code-container">
                                <div class="qr-code">📱</div>
                                <p>Open the App on Your Child's Device and Scan the QR Code</p>
                                <p style="margin: 20px 0;">Or Enter the Code Manually:</p>
                                <div class="binding-code" id="bindingCode">5H8J9</div>
                                <p>The Code Is Valid for 10 Minutes</p>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button id="generateNewCodeBtn" class="btn btn-outline"><i class="fas fa-sync-alt"></i> Generate New Code</button>
                            </div>
                        </div>
                    </div>

                    <div id="manageDevicesTab" class="tab-pane">
                        <div class="card">
                            <h2 style="margin-bottom: 20px;">Manage Devices</h2>
                            <div class="devices-grid" id="manageDevicesGrid">
                                <!-- Devices will be added dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Page -->
        <div id="monitoringPage" class="page">
            <h1 class="page-title"><i class="fas fa-eye"></i> Monitoring <span class="ai-analysis-tag"><i class="fas fa-robot"></i> AI-Powered</span></h1>

            <div class="monitoring-container">
                <div class="categories-sidebar">
                    <div class="categories-sidebar-header">
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="categorySearch" placeholder="Search categories..." class="search-input">
                        </div>
                        <button id="addCategoryBtn" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>

                    <div class="categories-filter">
                        <div class="filter-tab active" data-filter="all">All</div>
                        <div class="filter-tab" data-filter="restricted">Blocked</div>
                        <div class="filter-tab" data-filter="limited">Limited</div>
                        <div class="filter-tab" data-filter="ai">AI-Generated</div>
                    </div>

                    <div id="categoriesList">
                        <!-- Categories will be added dynamically -->
                    </div>

                    <div class="category-stats-summary">
                        <div class="stat-item">
                            <div class="stat-value" id="categoriesCount">0</div>
                            <div class="stat-label">Categories</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalScreenshots">0</div>
                            <div class="stat-label">Screenshots</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="aiCategories">0</div>
                            <div class="stat-label">AI Categories</div>
                        </div>
                    </div>
                </div>

                <div class="monitoring-content">
                    <div class="content-header">
                        <div class="header-left">
                            <h3 id="currentCategoryTitle">All Screenshots</h3>
                            <p id="screenshotsCount" class="text-muted">0 screenshots</p>
                        </div>
                        <div class="header-right">
                            <div class="view-toggle">
                                <button class="btn btn-icon active" data-view="grid">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button class="btn btn-icon" data-view="list">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                            <button class="btn btn-outline" id="exportScreenshots">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>

                    <div class="monitoring-filters">
                        <div class="filter-group">
                            <label for="dateRangePicker">Date Range</label>
                            <input type="text" id="dateRangePicker" class="form-control" placeholder="Select date range">
                        </div>

                        <div class="filter-group">
                            <label for="deviceFilter">Device</label>
                            <select id="deviceFilter" class="form-control">
                                <option value="all">All Devices</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="sortFilter">Sort By</label>
                            <select id="sortFilter" class="form-control">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <button id="applyFiltersBtn" class="btn btn-primary" style="margin-top: 24px;">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <div class="screenshots-grid" id="screenshotsGrid">
                        <!-- Screenshots will be added dynamically -->
                    </div>

                    <div class="pagination">
                        <button class="btn btn-outline" id="prevPage" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="page-info">Page 1 of 5</span>
                        <button class="btn btn-outline" id="nextPage">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Page -->
        <div id="statisticsPage" class="page">
            <h1 class="page-title"><i class="fas fa-chart-bar"></i> Statistics</h1>

            <div class="card">
                <div class="stats-controls">
                    <div>
                        <label for="statsDeviceFilter">Device:</label>
                        <select id="statsDeviceFilter" class="form-control">
                            <option value="all">All Devices</option>
                        </select>
                    </div>

                    <div>
                        <label for="statsTimeFilter">Period:</label>
                        <select id="statsTimeFilter" class="form-control">
                            <option value="day">Last 24 Hours</option>
                            <option value="week">Last Week</option>
                            <option value="month">Last Month</option>
                            <option value="year">Last Year</option>
                        </select>
                    </div>

                    <div class="chart-type-selector">
                        <button class="btn btn-outline active" data-type="bar"><i class="fas fa-chart-bar"></i> Bar</button>
                        <button class="btn btn-outline" data-type="line"><i class="fas fa-chart-line"></i> Line</button>
                        <button class="btn btn-outline" data-type="pie"><i class="fas fa-chart-pie"></i> Pie</button>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-trend">Today</div>
                        </div>
                        <div class="stat-value" id="totalUsage">4h 22m</div>
                        <div class="stat-label">Total Usage</div>
                        <div class="stat-progress">
                            <div class="progress-bar" style="width: 65%"></div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon"><i class="fas fa-mobile-alt"></i></div>
                            <div class="stat-trend">Most Used</div>
                        </div>
                        <div class="stat-value" id="mostUsedDevice">Tom's iPad</div>
                        <div class="stat-label">Most Used Device</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
                            <div class="stat-trend">Avg. Daily</div>
                        </div>
                        <div class="stat-value" id="avgDailyUsage">2h 15m</div>
                        <div class="stat-label">Avg. Daily Usage</div>
                        <div class="stat-progress">
                            <div class="progress-bar" style="width: 45%"></div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon"><i class="fas fa-ban"></i></div>
                            <div class="stat-trend">Blocked</div>
                        </div>
                        <div class="stat-value" id="blockedTime">3h 40m</div>
                        <div class="stat-label">Blocked Time</div>
                        <div class="stat-progress">
                            <div class="progress-bar" style="width: 55%"></div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="usageChart"></canvas>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <div class="card-header">
                        <h2>App Usage Breakdown</h2>
                        <button id="toggleAppChart" class="btn btn-outline">
                            <i class="fas fa-chevron-down"></i> Show Details
                        </button>
                    </div>
                    <div id="appUsageContainer" style="display: none;">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="appUsageChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <div class="card-header">
                        <h2>Category Analysis</h2>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <div class="comparison-container">
                    <div class="card">
                        <div class="card-header">
                            <h2>Weekly Comparison</h2>
                        </div>
                        <div class="chart-container comparison-chart">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Usage Trend</h2>
                        </div>
                        <div class="usage-comparison">
                            <div class="comparison-item">
                                <div class="comparison-value" id="currentWeek">12h</div>
                                <div class="comparison-label">This Week</div>
                            </div>
                            <div class="comparison-item">
                                <div class="comparison-value" id="previousWeek">14h</div>
                                <div class="comparison-label">Previous Week</div>
                            </div>
                            <div class="comparison-item">
                                <div class="comparison-value" id="trendPercentage">-14%</div>
                                <div class="comparison-label">Change</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="page">
            <h1 class="page-title"><i class="fas fa-user-cog"></i> Profile</h1>

            <div class="profile-grid">
                <div class="card profile-card">
                    <form id="profileForm">
                        <div class="form-group">
                            <label for="profileFirstName">First Name</label>
                            <input type="text" id="profileFirstName" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="profileLastName">Last Name</label>
                            <input type="text" id="profileLastName" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="profileEmail">Email</label>
                            <input type="email" id="profileEmail" class="form-control" disabled>
                        </div>

                        <div class="form-group">
                            <label for="profilePhone">Phone</label>
                            <input type="tel" id="profilePhone" class="form-control">
                        </div>

                        <div class="form-group">
                            <label for="profileTimezone">Timezone</label>
                            <select id="profileTimezone" class="form-control">
                                <option value="UTC-12">UTC-12:00</option>
                                <option value="UTC-11">UTC-11:00</option>
                                <option value="UTC-10">UTC-10:00</option>
                                <option value="UTC-9">UTC-09:00</option>
                                <option value="UTC-8">UTC-08:00</option>
                                <option value="UTC-7">UTC-07:00</option>
                                <option value="UTC-6">UTC-06:00</option>
                                <option value="UTC-5">UTC-05:00</option>
                                <option value="UTC-4">UTC-04:00</option>
                                <option value="UTC-3">UTC-03:00</option>
                                <option value="UTC-2">UTC-02:00</option>
                                <option value="UTC-1">UTC-01:00</option>
                                <option value="UTC">UTC±00:00</option>
                                <option value="UTC+1">UTC+01:00</option>
                                <option value="UTC+2">UTC+02:00</option>
                                <option value="UTC+3">UTC+03:00</option>
                                <option value="UTC+4">UTC+04:00</option>
                                <option value="UTC+5">UTC+05:00</option>
                                <option value="UTC+6">UTC+06:00</option>
                                <option value="UTC+7">UTC+07:00</option>
                                <option value="UTC+8">UTC+08:00</option>
                                <option value="UTC+9">UTC+09:00</option>
                                <option value="UTC+10">UTC+10:00</option>
                                <option value="UTC+11">UTC+11:00</option>
                                <option value="UTC+12">UTC+12:00</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="theme">Theme</label>
                            <div class="theme-switcher">
                                <div class="theme-option theme-light active" data-theme="light"></div>
                                <div class="theme-option theme-dark" data-theme="dark"></div>
                                <div class="theme-option theme-system" data-theme="system"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="timeFormat">Time Format</label>
                            <select id="timeFormat" class="form-control">
                                <option value="12">12-hour</option>
                                <option value="24">24-hour</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2>Account Security</h2>
                    <div class="form-group">
                        <label>Change Password</label>
                        <input type="password" id="currentPassword" class="form-control" placeholder="Current password">
                        <input type="password" id="newPassword" class="form-control mt-2" placeholder="New password">
                        <input type="password" id="confirmPassword" class="form-control mt-2" placeholder="Confirm new password">
                        <button id="changePasswordBtn" class="btn btn-primary mt-2">Change Password</button>
                    </div>
                </div>

                <div class="card">
                    <h2>Subscription</h2>
                    <p>Your current plan: <strong>FamilyGuard Premium</strong></p>
                    <p>Expires on: <strong>December 31, 2025</strong></p>
                    <button class="btn btn-outline">Manage Subscription</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for adding device -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Device</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="deviceForm">
                    <div class="form-group">
                        <label for="deviceName">Device Name</label>
                        <input type="text" id="deviceName" class="form-control" placeholder="e.g., John's iPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="deviceModel">Model</label>
                        <input type="text" id="deviceModel" class="form-control" placeholder="e.g., iPhone 13">
                    </div>
                    <div class="form-group">
                        <label for="deviceOS">OS Version</label>
                        <input type="text" id="deviceOS" class="form-control" placeholder="e.g., iOS 15.4">
                    </div>
                    <div class="form-group">
                        <label for="tetheringCode">Tethering Code</label>
                        <input type="text" id="tetheringCode" class="form-control" placeholder="Enter tethering code" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-modal">Cancel</button>
                <button id="saveDeviceBtn" class="btn btn-primary">Add Device</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding/editing category -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="categoryModalTitle">Add New Category</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div class="form-group">
                        <label for="categoryName">Category Name</label>
                        <input type="text" id="categoryName" class="form-control" placeholder="e.g., Social Media" required>
                    </div>

                    <div class="form-group">
                        <label for="categoryApp">App Name</label>
                        <input type="text" id="categoryApp" class="form-control" placeholder="e.g., Media" required>
                    </div>

                    <div class="form-group">
                        <label>Icon</label>
                        <div class="emoji-picker" id="emojiPicker">
                            <!-- Emojis will be populated by JavaScript -->
                        </div>
                        <input type="hidden" id="categoryIcon" value="📱">
                    </div>

                    <div class="form-group">
                        <div class="toggle-container">
                            <label class="switch">
                                <input type="checkbox" id="categoryRestricted">
                                <span class="slider"></span>
                            </label>
                            <span class="toggle-label">Block this category completely</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Daily Time Limit (minutes)</label>
                        <div class="time-limit-controls">
                            <input type="number" id="timeLimit" class="form-control time-limit-input" placeholder="0 = no limit" min="0">
                            <div class="time-limit-buttons">
                                <button type="button" class="btn btn-sm btn-outline" data-minutes="30">30m</button>
                                <button type="button" class="btn btn-sm btn-outline" data-minutes="60">1h</button>
                                <button type="button" class="btn btn-sm btn-outline" data-minutes="120">2h</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-modal">Cancel</button>
                <button id="saveCategoryBtn" class="btn btn-primary">Save Category</button>
            </div>
        </div>
    </div>

    <!-- Screenshot Viewer Modal -->
    <div id="screenshotModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Screenshot Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body screenshot-viewer-container">
                <img id="screenshotViewer" class="screenshot-viewer" src="" alt="Screenshot">
                <div class="screenshot-viewer-controls">
                    <div class="zoom-controls">
                        <button class="btn btn-outline" id="zoomInBtn">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="btn btn-outline" id="zoomOutBtn">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="btn btn-outline" id="resetZoomBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <button class="btn btn-primary" id="downloadScreenshotBtn">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
                <div class="screenshot-meta-info">
                    <div id="screenshotDeviceInfo"><i class="fas fa-mobile-alt"></i> <span></span></div>
                    <div id="screenshotDateInfo"><i class="fas fa-calendar-alt"></i> <span></span></div>
                    <div id="screenshotAiInfo"><i class="fas fa-robot"></i> <span></span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-modal">Close</button>
                <button id="deleteScreenshotBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Device Confirmation Modal -->
    <div id="deleteDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Device Removal</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-dialog">
                    <p id="deleteDeviceMessage">Are you sure you want to remove this device?</p>
                    <div class="confirmation-buttons">
                        <button class="btn btn-outline close-modal">Cancel</button>
                        <button id="confirmDeleteDevice" class="btn btn-delete">Delete Device</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>FamilyGuard: AI Powered Parental Control © 2025</p>
        </div>
    </footer>

    <script>
        // API Configuration
        const API_BASE_URL = window.location.origin;
        const TOKEN_KEY = 'familyguard_token';
        const USER_KEY = 'familyguard_user';

        // DOM Elements
        const notificationEl = document.getElementById('notification');
        const registerForm = document.getElementById('registerForm');
        const loginForm = document.getElementById('loginForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const registerPage = document.getElementById('registerPage');
        const loginPage = document.getElementById('loginPage');
        const userMenu = document.getElementById('userMenu');
        const mainNav = document.getElementById('mainNav');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const dashboardPage = document.getElementById('dashboardPage');
        const devicesPage = document.getElementById('devicesPage');
        const monitoringPage = document.getElementById('monitoringPage');
        const statisticsPage = document.getElementById('statisticsPage');
        const profilePage = document.getElementById('profilePage');
        const devicesGrid = document.getElementById('devicesGrid');
        const manageDevicesGrid = document.getElementById('manageDevicesGrid');
        const addDeviceBtn = document.getElementById('addDeviceBtn');
        const deviceModal = document.getElementById('deviceModal');
        const saveDeviceBtn = document.getElementById('saveDeviceBtn');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const deviceForm = document.getElementById('deviceForm');
        const bindingCodeEl = document.getElementById('bindingCode');
        const generateNewCodeBtn = document.getElementById('generateNewCodeBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const emergencyLockBtn = document.getElementById('emergencyLock');
        const globalLoader = document.getElementById('globalLoader');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const categoryModal = document.getElementById('categoryModal');
        const saveCategoryBtn = document.getElementById('saveCategoryBtn');
        const categoryForm = document.getElementById('categoryForm');
        const categoriesList = document.getElementById('categoriesList');
        const themeOptions = document.querySelectorAll('.theme-option');
        const profileForm = document.getElementById('profileForm');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const dateFilter = document.getElementById('dateFilter');
        const deviceFilter = document.getElementById('deviceFilter');
        const sortFilter = document.getElementById('sortFilter');
        const screenshotsGrid = document.getElementById('screenshotsGrid');
        const currentCategoryTitle = document.getElementById('currentCategoryTitle');
        const screenshotsCount = document.getElementById('screenshotsCount');
        const emojiPicker = document.getElementById('emojiPicker');
        const screenshotModal = document.getElementById('screenshotModal');
        const screenshotViewer = document.getElementById('screenshotViewer');
        const deleteScreenshotBtn = document.getElementById('deleteScreenshotBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetZoomBtn = document.getElementById('resetZoomBtn');
        const downloadScreenshotBtn = document.getElementById('downloadScreenshotBtn');
        const deleteDeviceModal = document.getElementById('deleteDeviceModal');
        const confirmDeleteDevice = document.getElementById('confirmDeleteDevice');
        const deleteDeviceMessage = document.getElementById('deleteDeviceMessage');
        const dateRangePicker = document.getElementById('dateRangePicker');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const categorySearch = document.getElementById('categorySearch');
        const exportScreenshots = document.getElementById('exportScreenshots');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const pageInfo = document.querySelector('.page-info');
        const aiCategoriesCount = document.getElementById('aiCategories');
        const screenshotAiInfo = document.getElementById('screenshotAiInfo').querySelector('span');

        // Chart instances
        let usageChartInstance = null;
        let appUsageChartInstance = null;
        let categoryChartInstance = null;
        let comparisonChartInstance = null;

        // Current data
        let currentUsageData = null;
        let currentStatsData = null;
        let devices = [];
        let categories = [];
        let currentEditingCategoryId = null;
        let currentCategoryId = 'all';
        let currentPage = 1;
        const itemsPerPage = 12;

        // Popular emojis for categories
        const EMOJIS = [
            '📱', '💻', '🖥️', '🎮', '📺', '🎬', '🎵', '🎧', '📚', '🛒',
            '💰', '🏦', '✈️', '🏨', '🍔', '☕', '🏠', '🚗', '🚲', '✏️',
            '📝', '📊', '📈', '📉', '🔍', '🔒', '❤️', '👍', '👎', '😀',
            '😢', '😡', '🤔', '💡', '🔔', '⏰', '📅', '📷', '🎥', '📞',
            '✉️', '🌐', '🔗', '📌', '📍', '🔎', '🛑', '✅', '❌', '➕',
            '➖', '❓', '❗', '⭐', '🎯', '🏆', '⚽', '🏀', '🎾', '🎲'
        ];

        // Show notification
        function showNotification(message, type = 'success') {
            notificationEl.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' :
                                         type === 'error' ? 'fa-exclamation-circle' :
                                         type === 'warning' ? 'fa-exclamation-triangle' :
                                         'fa-info-circle'}"></i>
                ${message}
            `;
            notificationEl.className = `notification ${type}`;
            notificationEl.style.display = 'flex';

            setTimeout(() => {
                notificationEl.style.display = 'none';
            }, 5000);
        }

        // Show/hide loader
        function showLoader() {
            globalLoader.style.display = 'flex';
        }

        function hideLoader() {
            globalLoader.style.display = 'none';
        }

        // Navigate between pages
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
                if (page.id === `${pageId}Page`) {
                    page.classList.add('active');
                }
            });

            navLinks.forEach(link => link.classList.remove('active'));

            if (pageId !== 'login' && pageId !== 'register') {
                document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');
            }

            // Load page-specific data
            if (pageId === 'dashboard') loadDashboard();
            else if (pageId === 'devices') loadDevicesPage();
            else if (pageId === 'monitoring') loadMonitoringPage();
            else if (pageId === 'statistics') loadStats();
            else if (pageId === 'profile') loadProfile();
        }

        // Get current user
        function getCurrentUser() {
            const user = localStorage.getItem(USER_KEY);
            return user ? JSON.parse(user) : null;
        }

        // Load user info
        function loadUserInfo() {
            const user = getCurrentUser();
            if (user) {
                userMenu.innerHTML = `
                    <div class="user-avatar">${user.firstName.charAt(0)}${user.lastName.charAt(0)}</div>
                    <div>${user.firstName} ${user.lastName}</div>
                    <button id="logoutBtn" class="btn btn-login"><i class="fas fa-sign-out-alt"></i> Log Out</button>
                `;

                mainNav.style.display = 'block';

                // Add logout event listener
                document.getElementById('logoutBtn')?.addEventListener('click', logout);
            } else {
                userMenu.innerHTML = `
                    <div class="auth-buttons">
                        <button id="showLoginBtn" class="btn btn-login">Login</button>
                        <button id="showRegisterBtn" class="btn btn-register">Register</button>
                    </div>
                `;

                mainNav.style.display = 'none';

                // Add event listeners for auth buttons
                document.getElementById('showLoginBtn')?.addEventListener('click', () => showPage('login'));
                document.getElementById('showRegisterBtn')?.addEventListener('click', () => showPage('register'));
            }
        }

        // API request
        async function apiRequest(url, method, body = null) {
            showLoader();
            const headers = {
                'Content-Type': 'application/json'
            };

            // Add token if available
            const token = localStorage.getItem(TOKEN_KEY);
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const options = {
                method,
                headers
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${url}`, options);
                const data = await response.json();

                if (!response.ok) {
                    const error = data.message || `Request failed: ${response.status}`;
                    if (response.status === 401) {
                        logout();
                    }
                    throw new Error(error);
                }

                return data;
            } catch (error) {
                console.error('API request error:', error);
                throw error;
            } finally {
                hideLoader();
            }
        }

        // Register user
        async function registerUser(userData) {
            try {
                const response = await apiRequest('/api/v1/register', 'POST', userData);
                showNotification('Account created successfully! Please login.', 'success');
                showPage('login');
            } catch (error) {
                let errorMsg = 'Registration failed';

                if (error.message.includes('Email already exists')) {
                    errorMsg = 'Email already exists';
                } else if (error.message.includes('Invalid input')) {
                    errorMsg = 'Please fill all required fields correctly';
                }

                showNotification(`${errorMsg}: ${error.message}`, 'error');
            }
        }

        // Login user
        async function loginUser(credentials) {
            try {
                const response = await apiRequest('/api/v1/login', 'POST', credentials);

                if (response.status === "success") {
                    // Save token and user info
                    localStorage.setItem(TOKEN_KEY, response.data.token);
                    localStorage.setItem(USER_KEY, JSON.stringify({
                        userId: response.data.userId,
                        email: response.data.email,
                        firstName: response.data.firstName,
                        lastName: response.data.lastName
                    }));

                    showNotification('Login successful!', 'success');
                    loadUserInfo();
                    showPage('dashboard');
                } else {
                    throw new Error(response.message || "Invalid credentials");
                }
            } catch (error) {
                let errorMsg = 'Login failed';

                if (error.message.includes('Invalid credentials')) {
                    errorMsg = 'Invalid email or password';
                }

                showNotification(`${errorMsg}: ${error.message}`, 'error');
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem(USER_KEY);
            showNotification('You have been logged out', 'success');
            loadUserInfo();
            showPage('login');
        }

        // ==============================================
        // DEVICE MANAGEMENT FUNCTIONALITY
        // ==============================================

        // Function to load devices into a grid
        async function loadDevicesGrid(gridElement, isDashboard = false) {
            try {
                const data = await apiRequest('/api/v1/devices', 'GET');
                devices = data.data || [];
                gridElement.innerHTML = '';

                if (devices.length > 0) {
                    devices.forEach(device => {
                        const isBlocked = device.isBlocked;
                        const statusClass = isBlocked ? 'blocked' : 'online';
                        const buttonClass = isBlocked ? 'btn-success' : 'btn-danger';
                        const buttonIcon = isBlocked ? 'fa-lock-open' : 'fa-lock';
                        const buttonText = isBlocked ? 'Unblock' : 'Block';
                        const action = isBlocked ? 'unblock' : 'block';

                        const deviceCard = document.createElement('div');
                        deviceCard.className = 'device-card';
                        deviceCard.innerHTML = `
                            <div class="device-header">
                                <div class="device-name">
                                    <i class="fas fa-mobile-alt"></i>
                                    <span class="device-name-text">${device.name}</span>
                                </div>
                                <div class="device-actions">
                                    <button class="btn btn-icon edit-device-name" data-device="${device.deviceId}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${!isDashboard ? `
                                    <button class="btn btn-icon btn-delete delete-device" data-device="${device.deviceId}">
                                        <i class="fas fa-trash"></i>
                                    </button>` : ''}
                                </div>
                            </div>
                            <div class="device-info-grid">
                                <div>
                                    <i class="fas fa-microchip"></i>
                                    <span>${device.model || 'N/A'}</span>
                                </div>
                                <div>
                                    <i class="fas fa-code-branch"></i>
                                    <span>${device.osVersion || 'N/A'}</span>
                                </div>
                                <div>
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Status: ${isBlocked ? 'Blocked' : 'Online'}</span>
                                </div>
                                <div>
                                    <i class="fas fa-clock"></i>
                                    <span>Last active: 5 min ago</span>
                                </div>
                            </div>
                            <div class="device-actions">
                                <button class="btn ${buttonClass} btn-block"
                                        data-device="${device.deviceId}"
                                        data-action="${action}">
                                    <i class="fas ${buttonIcon}"></i>
                                    ${buttonText}
                                </button>
                                <button class="btn btn-outline btn-block locate-btn"
                                        data-device="${device.deviceId}">
                                    <i class="fas fa-map-marker-alt"></i> Locate
                                </button>
                            </div>
                            <div class="device-status ${statusClass}"></div>
                        `;
                        gridElement.appendChild(deviceCard);
                    });
                } else {
                    gridElement.innerHTML = `
                        <div class="empty-state" ${isDashboard ? 'style="grid-column: 1/-1;"' : ''}>
                            <i class="fas fa-mobile-alt"></i>
                            <h3>No Devices Found</h3>
                            <p>You haven't added any devices yet.</p>
                            ${isDashboard ? `
                            <button id="addFirstDeviceBtn" class="btn btn-primary" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> Add Your First Device</button>` : ''}
                        </div>
                    `;

                    if (isDashboard) {
                        document.getElementById('addFirstDeviceBtn')?.addEventListener('click', () => {
                            showPage('devices');
                        });
                    }
                }
            } catch (error) {
                showNotification(`Error loading devices: ${error.message}`, 'error');
            }
        }

        // Delete device
        async function deleteDevice(deviceId) {
            try {
                const device = devices.find(d => d.deviceId === deviceId);
                if (!device) return;

                await apiRequest(`/api/v1/devices/${deviceId}`, 'DELETE');
                showNotification(`Device "${device.name}" has been removed`, 'success');

                // Refresh device lists
                await Promise.all([loadDashboard(), loadManageDevices()]);
            } catch (error) {
                showNotification(`Error deleting device: ${error.message}`, 'error');
            } finally {
                // Close modal
                deleteDeviceModal.style.display = 'none';
            }
        }

        // Load devices for dashboard
        async function loadDashboard() {
            await loadDevicesGrid(devicesGrid, true);
            loadRecentNotifications();
        }

        // Load devices for management
        async function loadManageDevices() {
            await loadDevicesGrid(manageDevicesGrid);
        }

        // Load devices page
        async function loadDevicesPage() {
            // Generate initial code
            await generateTetheringCode();
            // Load devices for management tab
            await loadManageDevices();
        }

        // Generate tethering code
        async function generateTetheringCode() {
            try {
                const data = await apiRequest('/api/v1/tethering-code', 'POST');
                bindingCodeEl.textContent = data.data.code;
                showNotification('New tethering code generated', 'success');
            } catch (error) {
                showNotification(`Error generating code: ${error.message}`, 'error');
            }
        }

        // Add new device
        async function addDevice(deviceData) {
            try {
                // Show loading state
                saveDeviceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
                saveDeviceBtn.disabled = true;

                // Send request
                await apiRequest('/api/v1/devices', 'POST', deviceData);

                showNotification(`Device "${deviceData.name}" added successfully`, 'success');

                // Close modal and reset form
                deviceModal.style.display = 'none';
                deviceForm.reset();

                // Refresh device lists
                await Promise.all([loadDashboard(), loadManageDevices()]);
            } catch (error) {
                showNotification(`Error adding device: ${error.message}`, 'error');
            } finally {
                // Restore button state
                saveDeviceBtn.innerHTML = 'Add Device';
                saveDeviceBtn.disabled = false;
            }
        }

        // Block/unblock device
        async function toggleDeviceBlock(deviceId, action) {
            try {
                // Find the button and set loading state
                const button = document.querySelector(`[data-device="${deviceId}"][data-action="${action}"]`);
                if (button) {
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                    button.disabled = true;

                    // Send request
                    await apiRequest(`/api/v1/devices/${deviceId}/${action}`, 'POST');

                    showNotification(`Device ${action === 'block' ? 'blocked' : 'unblocked'}`, 'success');

                    // Refresh device lists
                    await Promise.all([loadDashboard(), loadManageDevices()]);
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // ==============================================
        // MONITORING FUNCTIONALITY
        // ==============================================

        async function createDefaultCategories() {
    const defaultCategories = [
        { name: "Social Media", icon: "📱", restricted: false, time_limit: 60 },
        { name: "Games", icon: "🎮", restricted: false, time_limit: 60 },
        { name: "Education", icon: "📚", restricted: false, time_limit: 0 },
        { name: "Entertainment", icon: "🎬", restricted: false, time_limit: 90 },
        { name: "Adult Content", icon: "🔞", restricted: true, time_limit: 0 }
    ];

    try {
        for (const category of defaultCategories) {
            await apiRequest('/api/v1/categories', 'POST', {
                name: category.name,
                icon: category.icon,
                restricted: category.restricted,
                time_limit: category.time_limit,
                label: category.name,
                description: ""
            });
        }
        showNotification('Default categories created', 'success');
    } catch (error) {
        console.error('Error creating default categories:', error);
    }
}

async function loadCategories() {
    try {
        const response = await apiRequest('/api/v1/categories', 'GET');
        categories = Array.isArray(response)
            ? response
            : response.data || [];

        // Create default categories if none exist
        if (categories.length === 0) {
            await createDefaultCategories();
            // Reload categories after creation
            const responseAgain = await apiRequest('/api/v1/categories', 'GET');
            categories = Array.isArray(responseAgain)
                ? responseAgain
                : responseAgain.data || [];
        }

        renderCategories();
    } catch (error) {
        showNotification(`Error loading categories: ${error.message}`, 'error');
        categories = [];
    }
}



        // Initialize emoji picker
        function initEmojiPicker() {
            emojiPicker.innerHTML = '';

            EMOJIS.forEach(emoji => {
                const emojiOption = document.createElement('div');
                emojiOption.className = 'emoji-option';
                emojiOption.textContent = emoji;
                emojiOption.addEventListener('click', () => {
                    document.querySelectorAll('.emoji-option').forEach(opt =>
                        opt.classList.remove('selected'));
                    emojiOption.classList.add('selected');
                    document.getElementById('categoryIcon').value = emoji;
                });
                emojiPicker.appendChild(emojiOption);
            });

            // Select first emoji by default
            if (EMOJIS.length > 0) {
                emojiPicker.firstChild?.classList.add('selected');
                document.getElementById('categoryIcon').value = EMOJIS[0];
            }
        }

        // Load monitoring page
        async function loadMonitoringPage() {
            // Show loading state
            screenshotsGrid.innerHTML = '<div class="screenshot-loading"></div>'.repeat(12);

            await loadCategories();
            await loadDevicesForFilter();

            // Initialize date picker
            flatpickr("#dateRangePicker", {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: ["today-7d", "today"]
            });

            await loadScreenshots();
            initMonitoringEventListeners();
        }

        // Load categories
        async function loadCategories() {
    try {
        const response = await apiRequest('/api/v1/categories', 'GET');

        // Исправленная обработка ответа:
        categories = Array.isArray(response)
            ? response
            : response.data || [];

        renderCategories();
    } catch (error) {
        showNotification(`Error loading categories: ${error.message}`, 'error');
        categories = [];
    }
}

        // Render categories
        function renderCategories() {
            categoriesList.innerHTML = '';

            // Add "All Categories" item
            const allItem = document.createElement('div');
            allItem.className = `category-item ${currentCategoryId === 'all' ? 'active' : ''}`;
            allItem.dataset.id = 'all';
            allItem.innerHTML = `
                <div class="category-icon">📂</div>
                <div class="category-info">
                    <div class="category-name">All Categories</div>
                </div>
            `;
            categoriesList.appendChild(allItem);

            // Add categories
            const aiCategories = categories.filter(c => c.created_by_ai);
            aiCategoriesCount.textContent = aiCategories.length;

            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = `category-item ${currentCategoryId === category.id ? 'active' : ''}`;
                categoryItem.dataset.id = category.id;
                categoryItem.innerHTML = `
                    <div class="category-icon">${category.icon}</div>
                    <div class="category-info">
                        <div class="category-name">${category.name}</div>
                        <div class="category-stats">
                            ${category.time_limit > 0 ?
                                `<span>${category.time_limit} min limit</span>` :
                                `<span>No limit</span>`}
                        </div>
                    </div>
                    ${category.created_by_ai ? `<div class="category-badge ai-badge">AI</div>` : ''}
                    ${category.restricted ? `<div class="category-badge">Blocked</div>` : ''}
                    <div class="category-actions">
                        <div class="category-action-btn edit-category" data-id="${category.id}">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="category-action-btn delete-category" data-id="${category.id}">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                `;
                categoriesList.appendChild(categoryItem);
            });

            document.getElementById('categoriesCount').textContent = categories.length;
        }

        // Load devices for filter
        async function loadDevicesForFilter() {
            try {
                const data = await apiRequest('/api/v1/devices/filter', 'GET');
                const devices = data.data || [];
                const deviceFilter = document.getElementById('deviceFilter');

                // Clear existing options except "All Devices"
                while (deviceFilter.options.length > 1) {
                    deviceFilter.remove(1);
                }

                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = device.name;
                    deviceFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        // Load screenshots
        async function loadScreenshots() {
            try {
                // Prepare filters object
                const filters = {
                    page: currentPage,
                    per_page: itemsPerPage,
                    sort: sortFilter.value
                };

                // Apply device filter if not 'all'
                if (deviceFilter.value && deviceFilter.value !== 'all') {
                    filters.device_id = deviceFilter.value;
                }

                // Apply category filter if not 'all'
                if (currentCategoryId && currentCategoryId !== 'all') {
                    filters.category_id = currentCategoryId;
                }

                // Process date range if selected
                if (dateRangePicker.value) {
                    const dates = dateRangePicker.value.split(' to ');
                    filters.start_date = dates[0];
                    if (dates[1]) {
                        filters.end_date = dates[1];
                    }
                }

                // Build query string
                const queryParams = new URLSearchParams(filters).toString();

                // Make API request
                const response = await apiRequest(`/api/v1/screenshots?${queryParams}`, 'GET');

                // Clear previous screenshots
                screenshotsGrid.innerHTML = '';

                // Check if we got data
                if (!response.data || response.data.length === 0) {
                    showEmptyState();
                    updateScreenshotsHeader(0);
                    return;
                }

                // Process and display screenshots
                renderScreenshots(response.data);

                // Update pagination and header
                updatePaginationUI(response.pagination?.total_pages || 1);
                updateScreenshotsHeader(response.pagination?.total || response.data.length);

            } catch (error) {
                console.error('Error loading screenshots:', error);
                screenshotsGrid.innerHTML = `
                    <div class="empty-screenshots">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Screenshots</h3>
                        <p>${error.message || 'Please try again later'}</p>
                        <button class="btn btn-primary" onclick="loadScreenshots()">
                            <i class="fas fa-sync-alt"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Show empty state when no screenshots found
        function showEmptyState() {
            screenshotsGrid.innerHTML = `
                <div class="empty-screenshots">
                    <i class="fas fa-image"></i>
                    <h3>No Screenshots Found</h3>
                    <p>Try changing your filters or select a different category</p>
                </div>
            `;
        }

        // Update screenshots header with count and category
        function updateScreenshotsHeader(totalCount) {
            const title = document.getElementById('currentCategoryTitle');
            const countEl = document.getElementById('screenshotsCount');

            // Set category name
            if (currentCategoryId === 'all') {
                title.textContent = 'All Screenshots';
            } else {
                const category = categories.find(c => c.id == currentCategoryId);
                if (category) {
                    title.innerHTML = `<span style="margin-right: 10px;">${category.icon}</span> ${category.name}`;
                }
            }

            // Set count
            countEl.textContent = `${totalCount} ${totalCount === 1 ? 'screenshot' : 'screenshots'}`;
        }

        // Update pagination controls
        function updatePaginationUI(totalPages) {
            prevPage.disabled = currentPage <= 1;
            nextPage.disabled = currentPage >= totalPages;
            pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
        }

        // Render screenshots to the grid
        function renderScreenshots(screenshots) {
            screenshots.forEach(screenshot => {
                const imgPath = screenshot.image_url || screenshot.image;
                const src = `${API_BASE_URL}${imgPath.startsWith('/') ? '' : '/uploads/'}${imgPath}`;

                const screenshotCard = document.createElement('div');
                screenshotCard.className = 'screenshot-card';
                screenshotCard.innerHTML = `
                    <div class="screenshot-image-container">
                        <img src="${src}"
                             alt="Screenshot"
                             class="screenshot-image"
                             loading="lazy">
                    </div>
                    <div class="screenshot-meta">
                        <div class="screenshot-date">
                            ${formatDate(screenshot.created_at)}
                        </div>
                        <div class="screenshot-device">
                            <i class="fas fa-mobile-alt"></i>
                            <span>${screenshot.device_name}</span>
                        </div>
                        ${screenshot.ai_analysis ? `
                        <div class="screenshot-ai-info">
                            <i class="fas fa-robot"></i>
                            <span>${screenshot.ai_analysis}</span>
                        </div>` : ''}
                        <div class="screenshot-actions">
                            <button class="btn btn-sm btn-primary view-screenshot" data-id="${screenshot.id}">
                                <i class="fas fa-expand"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline delete-screenshot" data-id="${screenshot.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                screenshotsGrid.appendChild(screenshotCard);
            });

            setupScreenshotEventListeners();
        }

        // Format date for display
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error('Error formatting date:', dateString);
                return 'Unknown date';
            }
        }

        // Setup event listeners for screenshot actions
        function setupScreenshotEventListeners() {
            // View screenshot
            document.querySelectorAll('.view-screenshot').forEach(btn => {
                btn.addEventListener('click', () => {
                    const screenshotId = btn.dataset.id;
                    openScreenshotViewer(screenshotId);
                });
            });

            // Delete screenshot
            document.querySelectorAll('.delete-screenshot').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const screenshotId = btn.dataset.id;
                    deleteScreenshot(screenshotId);
                });
            });
        }

        // Open category modal
        function openCategoryModal(categoryId = null) {
            const modalTitle = document.getElementById('categoryModalTitle');
            const saveButton = document.getElementById('saveCategoryBtn');

            initEmojiPicker();

            if (categoryId) {
                // Edit mode
                const category = categories.find(c => c.id == categoryId);
                if (category) {
                    modalTitle.textContent = "Edit Category";
                    saveButton.textContent = "Save Changes";

                    document.getElementById('categoryName').value = category.name;
                    document.getElementById("App name").value = category.app_name;
                    document.getElementById('categoryRestricted').checked = category.restricted;
                    document.getElementById('timeLimit').value = category.time_limit;

                    // Select the correct emoji
                    setTimeout(() => {
                        document.querySelectorAll('.emoji-option').forEach(opt => {
                            if (opt.textContent === category.icon) {
                                opt.classList.add('selected');
                                document.getElementById('categoryIcon').value = category.icon;
                            }
                        });
                    }, 10);

                    currentEditingCategoryId = categoryId;
                }
            } else {
                // Add mode
                modalTitle.textContent = "Add New Category";
                saveButton.textContent = "Add Category";

                // Reset values
                document.getElementById('categoryName').value = '';
                document.getElementById('categoryRestricted').checked = false;
                document.getElementById('timeLimit').value = '';

                currentEditingCategoryId = null;
            }

            categoryModal.style.display = 'flex';
        }

        // Save category
        // Save category
async function saveCategory(categoryData) {
    try {
        const url = currentEditingCategoryId
            ? `/api/v1/categories/${currentEditingCategoryId}`
            : '/api/v1/categories';

        // Исправлено: используем PATCH вместо PUT
        const method = currentEditingCategoryId ? 'PATCH' : 'POST';

        // Формируем payload
        const payload = {
            name: categoryData.name,
            icon: categoryData.icon,
            restricted: categoryData.restricted,
            time_limit: parseInt(categoryData.timeLimit) || 0,
            label: categoryData.name,
            description: ""
        };

        console.log(`Sending ${method} request to: ${url}`, payload);

        const response = await apiRequest(url, method, payload);

        showNotification(
            `Category "${categoryData.name}" saved`,
            'success'
        );

        await loadCategories();
        categoryModal.style.display = 'none';
    } catch (error) {
        console.error('Error saving category:', error);
        showNotification(`Error saving category: ${error.message}`, 'error');
    }
}

        // Delete category
        async function deleteCategory(categoryId) {
            if (confirm('Are you sure you want to delete this category? Screenshots will not be deleted.')) {
                try {
                    await apiRequest(`/api/v1/categories/${categoryId}`, 'DELETE');
                    showNotification('Category deleted', 'success');

                    // If we were viewing this category, switch to "All"
                    if (currentCategoryId == categoryId) {
                        currentCategoryId = 'all';
                    }

                    await loadCategories();
                    await loadScreenshots();
                } catch (error) {
                    showNotification(`Error deleting category: ${error.message}`, 'error');
                }
            }
        }

        // Open screenshot viewer
        async function openScreenshotViewer(screenshotId) {
            try {
                const response = await apiRequest(`/api/v1/screenshots/${screenshotId}`, 'GET');
                const screenshot = response.data;

                if (!screenshot) return;

                // Set the screenshot data
                const imgPath = screenshot.image_url || screenshot.image;
                screenshotViewer.src = `${API_BASE_URL}${imgPath.startsWith('/') ? '' : '/uploads/'}${imgPath}`;
                screenshotViewer.style.transform = 'scale(1)';

                // Set metadata
                document.getElementById('screenshotDeviceInfo').querySelector('span').textContent = screenshot.device_name;
                document.getElementById('screenshotDateInfo').querySelector('span').textContent = formatDate(screenshot.created_at);
                screenshotAiInfo.textContent = screenshot.ai_analysis || 'No AI analysis available';

                // Set the delete button data
                deleteScreenshotBtn.dataset.screenshotId = screenshotId;

                screenshotModal.style.display = 'flex';
            } catch (error) {
                showNotification(`Error loading screenshot: ${error.message}`, 'error');
            }
        }

        // Delete screenshot
        async function deleteScreenshot(screenshotId) {
            if (confirm('Are you sure you want to delete this screenshot?')) {
                try {
                    await apiRequest(`/api/v1/screenshots/${screenshotId}`, 'DELETE');
                    showNotification('Screenshot deleted', 'success');

                    // Remove from UI
                    const screenshotElement = document.querySelector(`.screenshot-card[data-id="${screenshotId}"]`);
                    if (screenshotElement) {
                        screenshotElement.remove();
                    }

                    // Update counts
                    await loadCategories();
                    await loadScreenshots();

                    screenshotModal.style.display = 'none';
                } catch (error) {
                    showNotification(`Error deleting screenshot: ${error.message}`, 'error');
                }
            }
        }

        // Initialize monitoring event listeners
        function initMonitoringEventListeners() {
            // Category selection
            document.addEventListener('click', (e) => {
                if (e.target.closest('.category-item')) {
                    const item = e.target.closest('.category-item');
                    currentCategoryId = item.dataset.id;
                    renderCategories();
                    loadScreenshots();
                }

                // Edit category button
                if (e.target.closest('.edit-category')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.edit-category');
                    const categoryId = btn.dataset.id;
                    openCategoryModal(categoryId);
                }

                // Delete category button
                if (e.target.closest('.delete-category')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.delete-category');
                    const categoryId = btn.dataset.id;
                    deleteCategory(categoryId);
                }
            });

            // Time limit quick buttons
            document.querySelectorAll('.time-limit-buttons button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('timeLimit').value = btn.dataset.minutes;
                });
            });

            // Filter changes
            applyFiltersBtn.addEventListener('click', loadScreenshots);

            // Category search
            categorySearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.category-item').forEach(item => {
                    const name = item.querySelector('.category-name').textContent.toLowerCase();
                    if (name.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            // View toggle
            document.querySelectorAll('.view-toggle .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-toggle .btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const view = btn.dataset.view;
                    if (view === 'grid') {
                        screenshotsGrid.style.display = 'grid';
                    } else {
                        screenshotsGrid.style.display = 'none';
                    }
                });
            });

            // Export screenshots
            exportScreenshots.addEventListener('click', async () => {
                try {
                    showLoader();
                    const response = await apiRequest('/api/v1/screenshots/export', 'GET');

                    // Create a temporary link to trigger download
                    const link = document.createElement('a');
                    link.href = `${API_BASE_URL}${response.url}`;
                    link.download = 'screenshots_export.zip';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showNotification('Export started successfully', 'success');
                } catch (error) {
                    showNotification(`Export failed: ${error.message}`, 'error');
                } finally {
                    hideLoader();
                }
            });

            // Pagination
            prevPage.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadScreenshots();
                }
            });

            nextPage.addEventListener('click', () => {
                currentPage++;
                loadScreenshots();
            });

            // Zoom controls
            zoomInBtn.addEventListener('click', () => {
                const currentScale = parseFloat(screenshotViewer.style.transform.replace('scale(', '').replace(')', '')) || 1;
                screenshotViewer.style.transform = `scale(${currentScale + 0.2})`;
            });

            zoomOutBtn.addEventListener('click', () => {
                const currentScale = parseFloat(screenshotViewer.style.transform.replace('scale(', '').replace(')', '')) || 1;
                if (currentScale > 0.3) {
                    screenshotViewer.style.transform = `scale(${currentScale - 0.2})`;
                }
            });

            resetZoomBtn.addEventListener('click', () => {
                screenshotViewer.style.transform = 'scale(1)';
            });

            // Download screenshot
            downloadScreenshotBtn.addEventListener('click', () => {
                const link = document.createElement('a');
                link.href = screenshotViewer.src;
                link.download = `screenshot_${new Date().getTime()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // ==============================================
        // STATISTICS FUNCTIONALITY
        // ==============================================

        // Format time for statistics
        function minutes_to_hh_mm(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        // Load statistics
        async function loadStats() {
            try {
                const deviceFilter = document.getElementById('statsDeviceFilter').value;
                const timeFilter = document.getElementById('statsTimeFilter').value;

                const data = await apiRequest(`/api/v1/stats?device=${deviceFilter}&period=${timeFilter}`, 'GET');
                currentStatsData = data.data;
                currentUsageData = data.data.usageData;

                // Update cards
                document.getElementById('totalUsage').textContent = data.data.totalUsage;
                document.getElementById('mostUsedDevice').textContent = data.data.mostUsedDevice || '-';
                document.getElementById('avgDailyUsage').textContent = data.data.avgDailyUsage;
                document.getElementById('blockedTime').textContent = data.data.blockedTime;

                // Determine chart type
                const activeTypeBtn = document.querySelector('.chart-type-selector .btn.active');
                const chartType = activeTypeBtn ? activeTypeBtn.dataset.type : 'bar';

                // Render charts
                renderUsageChart(data.data.usageData, chartType);

                if (data.data.appUsage) {
                    renderAppUsageChart(data.data.appUsage);
                }

                if (data.data.categoryData) {
                    renderCategoryChart(data.data.categoryData);
                }

                // Update comparison
                document.getElementById('currentWeek').textContent = minutes_to_hh_mm(data.data.comparisonData.currentWeekTotal);
                document.getElementById('previousWeek').textContent = minutes_to_hh_mm(data.data.comparisonData.previousWeekTotal);

                const trend = data.data.comparisonData.trendPercentage;
                const trendElement = document.getElementById('trendPercentage');
                trendElement.textContent = `${Math.abs(trend)}%`;
                trendElement.className = 'comparison-value ' +
                    (trend > 0 ? 'trend-up' : trend < 0 ? 'trend-down' : 'trend-neutral');

                // Render comparison chart
                renderComparisonChart(data.data.comparisonData);

            } catch (error) {
                showNotification(`Error loading statistics: ${error.message}`, 'error');
            }
        }

        // Render usage chart
        function renderUsageChart(chartData, chartType = 'bar') {
            const ctx = document.getElementById('usageChart').getContext('2d');

            // Destroy previous chart
            if (usageChartInstance) {
                usageChartInstance.destroy();
            }

            // Determine color based on chart type
            const bgColor = chartType === 'bar' ?
                'rgba(67, 97, 238, 0.7)' :
                'rgba(67, 97, 238, 0.2)';

            const borderColor = 'rgba(67, 97, 238, 1)';

            const datasets = [{
                label: 'Screen Time (minutes)',
                data: chartData.data,
                backgroundColor: bgColor,
                borderColor: borderColor,
                borderWidth: 2,
                fill: chartType === 'line',
                tension: 0.4
            }];

            if (chartType === 'bar') {
                datasets[0].borderRadius = 5;
            }

            usageChartInstance = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: chartData.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${minutes_to_hh_mm(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Minutes'
                            },
                            ticks: {
                                callback: function(value) {
                                    return minutes_to_hh_mm(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render app usage chart
        function renderAppUsageChart(appData) {
            const ctx = document.getElementById('appUsageChart').getContext('2d');

            if (appUsageChartInstance) {
                appUsageChartInstance.destroy();
            }

            // Sort apps by usage
            const sortedApps = [...appData].sort((a, b) => b.minutes - a.minutes);
            const topApps = sortedApps.slice(0, 7);
            const otherMinutes = sortedApps.slice(7).reduce((sum, app) => sum + app.minutes, 0);

            const labels = topApps.map(app => app.name);
            const data = topApps.map(app => app.minutes);

            if (otherMinutes > 0) {
                labels.push('Other Apps');
                data.push(otherMinutes);
            }

            // Generate colors
            const backgroundColors = [
                'rgba(67, 97, 238, 0.7)',
                'rgba(76, 201, 240, 0.7)',
                'rgba(247, 37, 133, 0.7)',
                'rgba(255, 158, 0, 0.7)',
                'rgba(106, 76, 147, 0.7)',
                'rgba(63, 55, 201, 0.7)',
                'rgba(0, 168, 107, 0.7)',
                'rgba(128, 128, 128, 0.7)'
            ];

            appUsageChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${minutes_to_hh_mm(value)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // Render category chart
        function renderCategoryChart(categoryData) {
            const ctx = document.getElementById('categoryChart').getContext('2d');

            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }

            // Group data by category
            const categories = {};
            categoryData.forEach(app => {
                if (!categories[app.category]) {
                    categories[app.category] = 0;
                }
                categories[app.category] += app.minutes;
            });

            // Convert to array for chart
            const labels = Object.keys(categories);
            const data = Object.values(categories);

            // Generate colors
            const backgroundColors = labels.map((_, i) => {
                const hue = (i * 137.5) % 360; // Golden angle for color distribution
                return `hsla(${hue}, 70%, 65%, 0.7)`;
            });

            categoryChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${minutes_to_hh_mm(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render comparison chart
        function renderComparisonChart(comparisonData) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');

            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }

            comparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: comparisonData.labels,
                    datasets: [{
                        label: 'This Week',
                        data: comparisonData.currentWeek,
                        backgroundColor: 'rgba(67, 97, 238, 0.7)',
                        borderColor: 'rgba(67, 97, 238, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Previous Week',
                        data: comparisonData.previousWeek,
                        backgroundColor: 'rgba(108, 117, 125, 0.7)',
                        borderColor: 'rgba(108, 117, 125, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Minutes'
                            },
                            ticks: {
                                callback: function(value) {
                                    return minutes_to_hh_mm(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${minutes_to_hh_mm(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize chart listeners
        function initChartListeners() {
            // Chart type selector
            document.querySelectorAll('.chart-type-selector .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-type-selector .btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Re-render the chart with new type
                    if (currentUsageData) {
                        renderUsageChart(currentUsageData, this.dataset.type);
                    }
                });
            });

            // Toggle app chart
            document.getElementById('toggleAppChart').addEventListener('click', function() {
                const isVisible = appUsageContainer.style.display !== 'none';
                appUsageContainer.style.display = isVisible ? 'none' : 'block';
                this.innerHTML = isVisible ?
                    '<i class="fas fa-chevron-down"></i> Show Details' :
                    '<i class="fas fa-chevron-up"></i> Hide Details';

                // If chart is shown and not initialized, render it
                if (!isVisible && !appUsageChartInstance && currentStatsData?.appUsage) {
                    renderAppUsageChart(currentStatsData.appUsage);
                }
            });

            // Stats filters
            document.getElementById('statsDeviceFilter').addEventListener('change', loadStats);
            document.getElementById('statsTimeFilter').addEventListener('change', loadStats);
        }

        // ==============================================
        // PROFILE FUNCTIONALITY
        // ==============================================

        // Load profile
        async function loadProfile() {
            try {
                const data = await apiRequest('/api/v1/profile', 'GET');
                document.getElementById('profileFirstName').value = data.data.firstName;
                document.getElementById('profileLastName').value = data.data.lastName;
                document.getElementById('profileEmail').value = data.data.email;
                document.getElementById('profilePhone').value = data.data.phone || '';
                document.getElementById('profileTimezone').value = data.data.timezone;

                // Load theme preference
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.querySelector(`.theme-option[data-theme="${savedTheme}"]`)?.classList.add('active');

                // Load time format
                if (data.data.timeFormat) {
                    document.getElementById('timeFormat').value = data.data.timeFormat;
                }
            } catch (error) {
                showNotification(`Error loading profile: ${error.message}`, 'error');
            }
        }

        // Update profile
        async function updateProfile(profileData) {
            try {
                // Include theme in profile data
                profileData.theme = document.querySelector('.theme-option.active')?.dataset.theme || 'light';

                await apiRequest('/api/v1/profile', 'PUT', profileData);
                showNotification('Profile updated successfully!', 'success');

                // Update user in local storage
                const user = getCurrentUser();
                if (user) {
                    user.firstName = profileData.firstName;
                    user.lastName = profileData.lastName;
                    localStorage.setItem(USER_KEY, JSON.stringify(user));
                    loadUserInfo();
                }

                // Apply theme if changed
                setTheme(profileData.theme);
            } catch (error) {
                showNotification(`Error updating profile: ${error.message}`, 'error');
            }
        }

        // Change password
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Please fill all password fields', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }

            try {
                changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
                changePasswordBtn.disabled = true;

                await apiRequest('/api/v1/change-password', 'POST', {
                    currentPassword,
                    newPassword
                });

                showNotification('Password changed successfully!', 'success');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                showNotification(`Error changing password: ${error.message}`, 'error');
            } finally {
                changePasswordBtn.innerHTML = 'Change Password';
                changePasswordBtn.disabled = false;
            }
        }

        // Load recent notifications
        async function loadRecentNotifications() {
            try {
                const data = await apiRequest('/api/v1/notifications/recent', 'GET');
                const recentNotifications = document.getElementById('recentNotifications');
                recentNotifications.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach(notification => {
                        const notificationItem = document.createElement('div');
                        notificationItem.className = 'notification-item';
                        notificationItem.innerHTML = `
                            <div class="notification-icon">
                                <i class="fas ${notification.type === 'alert' ? 'fa-exclamation-triangle' :
                                               notification.type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i>
                            </div>
                            <div class="notification-content">
                                <h4>${notification.title}</h4>
                                <p>${notification.message}</p>
                                <div class="notification-time">${notification.time}</div>
                            </div>
                        `;
                        recentNotifications.appendChild(notificationItem);
                    });
                } else {
                    recentNotifications.innerHTML = `
                        <div class="text-center py-3 text-muted">
                            No recent notifications
                        </div>
                    `;
                }
            } catch (error) {
                // Fail silently for dashboard
            }
        }

        // Set theme
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
            localStorage.setItem('theme', theme);
        }

        // Event listeners
        function initEventListeners() {
            // Registration form
            if (registerForm) {
                registerForm.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const userData = {
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        email: document.getElementById('registerEmail').value,
                        password: document.getElementById('registerPassword').value,
                        timezone: document.getElementById('timezone').value,
                        phone: document.getElementById('phone').value
                    };

                    registerUser(userData);
                });
            }



            // Login form
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const credentials = {
                        email: document.getElementById('loginEmail').value,
                        password: document.getElementById('loginPassword').value
                    };

                    loginUser(credentials);
                });
            }

            // Show register page
            if (showRegister) {
                showRegister.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('register');
                });
            }

            // Show login page
            if (showLogin) {
                showLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('login');
                });
            }

            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.getAttribute('data-page');
                    showPage(page);
                });
            });

            // Mobile menu
            mobileMenuBtn.addEventListener('click', () => {
                mainNav.classList.toggle('active');
            });

            // Add device button
            addDeviceBtn.addEventListener('click', () => {
                deviceModal.style.display = 'flex';
            });

            // Save device button
            saveDeviceBtn.addEventListener('click', (e) => {
                e.preventDefault();

                const deviceData = {
                    name: document.getElementById('deviceName').value,
                    model: document.getElementById('deviceModel').value,
                    osVersion: document.getElementById('deviceOS').value,
                    tetheringCode: document.getElementById('tetheringCode').value
                };

                // Basic validation
                if (!deviceData.name || !deviceData.tetheringCode) {
                    showNotification('Device name and tethering code are required', 'error');
                    return;
                }

                addDevice(deviceData);
            });

            // Close modals
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    deviceModal.style.display = 'none';
                    categoryModal.style.display = 'none';
                    screenshotModal.style.display = 'none';
                    deleteDeviceModal.style.display = 'none';
                    deviceForm.reset();
                    categoryForm.reset();
                });
            });

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === deviceModal) {
                    deviceModal.style.display = 'none';
                    deviceForm.reset();
                }
                if (e.target === categoryModal) {
                    categoryModal.style.display = 'none';
                    categoryForm.reset();
                }
                if (e.target === screenshotModal) {
                    screenshotModal.style.display = 'none';
                }
                if (e.target === deleteDeviceModal) {
                    deleteDeviceModal.style.display = 'none';
                }
            });

            // Generate new code
            generateNewCodeBtn.addEventListener('click', generateTetheringCode);

            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));

                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                });
            });

            // Delegated event for device actions
            document.addEventListener('click', (e) => {
                const blockBtn = e.target.closest('[data-action="block"]');
                const unblockBtn = e.target.closest('[data-action="unblock"]');
                const deleteBtn = e.target.closest('.delete-device');

                if (blockBtn || unblockBtn) {
                    const btn = blockBtn || unblockBtn;
                    const deviceId = btn.getAttribute('data-device');
                    const action = btn.getAttribute('data-action');

                    toggleDeviceBlock(deviceId, action);
                }

                if (deleteBtn) {
                    const deviceId = deleteBtn.getAttribute('data-device');
                    const device = devices.find(d => d.deviceId === deviceId);

                    if (device) {
                        deleteDeviceMessage.textContent = `Are you sure you want to remove the device "${device.name}"? This action cannot be undone.`;
                        confirmDeleteDevice.dataset.deviceId = deviceId;
                        deleteDeviceModal.style.display = 'flex';
                    }
                }
            });

            // Confirm device deletion
            confirmDeleteDevice.addEventListener('click', (e) => {
                const deviceId = e.target.dataset.deviceId;
                deleteDevice(deviceId);
            });

            // Add category button
            addCategoryBtn.addEventListener('click', () => {
                openCategoryModal();
            });

            // Save category button
            saveCategoryBtn.addEventListener('click', (e) => {
                e.preventDefault();

                const categoryData = {
                    name: document.getElementById('categoryName').value,
                    icon: document.getElementById('categoryIcon').value,
                    restricted: document.getElementById('categoryRestricted').checked,
                    timeLimit: parseInt(document.getElementById('timeLimit').value) || 0
                };

                if (!categoryData.name) {
                    showNotification('Category name is required', 'error');
                    return;
                }

                saveCategory(categoryData);
            });

            // Profile form
            profileForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const profileData = {
                    firstName: document.getElementById('profileFirstName').value,
                    lastName: document.getElementById('profileLastName').value,
                    phone: document.getElementById('profilePhone').value,
                    timezone: document.getElementById('profileTimezone').value,
                    timeFormat: document.getElementById('timeFormat').value
                };

                updateProfile(profileData);
            });

            // Theme switcher
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    themeOptions.forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    const theme = option.dataset.theme;
                    setTheme(theme);
                });
            });

            // Change password
            changePasswordBtn.addEventListener('click', changePassword);

            // Emergency lock
            emergencyLockBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to lock all devices immediately?')) {
                    try {
                        showLoader();
                        await apiRequest('/api/v1/devices/emergency-lock', 'POST');
                        showNotification('All devices locked successfully', 'success');
                        loadDashboard();
                    } catch (error) {
                        showNotification(`Error: ${error.message}`, 'error');
                    } finally {
                        hideLoader();
                    }
                }
            });

            // Initialize chart listeners
            initChartListeners();
        }

        // Initialize app
        async function initApp() {
            // Set theme from localStorage
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);

            // Check server connection
            try {
                await apiRequest('/api/v1/ping', 'GET');
            } catch (error) {
                showNotification("Cannot connect to server. Please try again later.", "error");
                return;
            }

            const user = getCurrentUser();
            if (user) {
                loadUserInfo();
                showPage('dashboard');
            } else {
                showPage('login');
            }

            initEventListeners();
        }

        // Start the app
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
